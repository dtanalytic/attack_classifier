schema: '2.0'
stages:
  get_mitre_data:
    cmd: python src/get_mitre_data.py params.yaml
    deps:
    - path: data/external/enterprise-attack.json
      hash: md5
      md5: c94cce0ee047d11c5c4a7475259e04f6
      size: 44231946
    - path: src/get_mitre_data.py
      hash: md5
      md5: c1880bfff3969ec15e35844f1c53a8a7
      size: 5618
    params:
      params.yaml:
        get_data.divide_paras: true
    outs:
    - path: data/interim/label2tactic.json
      hash: md5
      md5: 5189286c02d7aa1ba4b5542d14a5f4aa
      size: 24536
    - path: data/interim/mitre.csv
      hash: md5
      md5: 4ed0ce571e432609d437c658984bee69
      size: 7876118
    - path: data/interim/mitre_attack.csv
      hash: md5
      md5: 607356d851cd1f40687be094abc78c1e
      size: 3075041
  get_add_data:
    cmd: python src/get_add_data.py params.yaml
    deps:
    - path: data/external/dataset.txt
      hash: md5
      md5: d0a5e5ec3a635aaa4277acef01371c13
      size: 1860959
    - path: data/external/multi_label.json
      hash: md5
      md5: 4e37ce4f0d60fb6c51d1c40ecee4dc12
      size: 5987464
    - path: data/external/rep_dn
      hash: md5
      md5: 8a078ab32bbba7bce63fc56078b66804.dir
      size: 742875
      nfiles: 25
    - path: data/interim/label2tactic.json
      hash: md5
      md5: 5189286c02d7aa1ba4b5542d14a5f4aa
      size: 24536
    - path: data/interim/mitre.csv
      hash: md5
      md5: 4ed0ce571e432609d437c658984bee69
      size: 7876118
    - path: data/interim/mitre_attack.csv
      hash: md5
      md5: 607356d851cd1f40687be094abc78c1e
      size: 3075041
    - path: src/get_add_data.py
      hash: md5
      md5: 4c4877a5a1a9afd5ed67d8c1013be99c
      size: 4750
    params:
      params.yaml:
        get_data.add_empty_reports: false
        get_data.data_fn: data/interim/mitre_full_df.csv
        get_data.target: tactic
        get_data.use_alt_mitre: false
        get_data.use_reports_f: true
        get_data.use_tram_f: true
    outs:
    - path: data/interim/mitre_full_df.csv
      hash: md5
      md5: 2154aaceacabfd7b9b9206ecec5cd717
      size: 6607239
  manual_data_filter:
    cmd: python src/manual_data_filter.py params.yaml
    deps:
    - path: data/interim/mitre_full_df.csv
      hash: md5
      md5: 2154aaceacabfd7b9b9206ecec5cd717
      size: 6607239
    - path: src/manual_data_filter.py
      hash: md5
      md5: 484c7ba808785ef1c6d02b9fb953933e
      size: 901
    outs:
    - path: data/interim/mitre_full_filt_df.csv
      hash: md5
      md5: ff5677aeb5fc95cadf734ed52514656e
      size: 6610629
  text_preprocess:
    cmd: python src/prep.py params.yaml
    deps:
    - path: data/interim/mitre_full_filt_df.csv
      hash: md5
      md5: ff5677aeb5fc95cadf734ed52514656e
      size: 6610629
    - path: src/prep.py
      hash: md5
      md5: 6b0481b892abc4e01bb535cb6c062325
      size: 5110
    - path: src/spec_funcs.py
      hash: md5
      md5: ba6e4fcee652c7e6160bffdb26204e74
      size: 18413
    params:
      params.yaml:
        prep_text.labelled_text_only: false
        prep_text.lower: false
        prep_text.max_len_token: 10
        prep_text.min_len_token: 3
        prep_text.replace_entities: true
        prep_text.save_only_words: false
        prep_text.stem_lemm: stem
        prep_text.stop_words: false
        prep_text.ttp_counts_thresh: 15
    outs:
    - path: data/interim/mlb.pkl
      hash: md5
      md5: 395e67e77481135535fc59d27bfd53f0
      size: 1380
    - path: data/interim/prep_df.csv
      hash: md5
      md5: 115e531ae3a4388f502e3e74743eb08b
      size: 28666193
    - path: data/interim/ttp/mlb.pkl
      hash: md5
      md5: 400dd1536fb247aeb574d6292afaf744
      size: 3478
  feature_generation:
    cmd: python src/feat_gen.py params.yaml
    deps:
    - path: data/interim/mlb.pkl
      hash: md5
      md5: 395e67e77481135535fc59d27bfd53f0
      size: 1380
    - path: data/interim/prep_df.csv
      hash: md5
      md5: 115e531ae3a4388f502e3e74743eb08b
      size: 28666193
    - path: src/feat_gen.py
      hash: md5
      md5: 279042be57417a698cdf1500bd34857d
      size: 886
    - path: src/spec_funcs.py
      hash: md5
      md5: ba6e4fcee652c7e6160bffdb26204e74
      size: 18413
    params:
      params.yaml:
        feat_gen.add_individual_thresh: 0.65
        feat_gen.binary: false
        feat_gen.feat_strategy: count
        feat_gen.ind_sel_tree_max_depth: 5
        feat_gen.logreg_c: 0.05
        feat_gen.max_df: 0.3
        feat_gen.max_features:
        feat_gen.min_df: 10
        feat_gen.tree_maxdepth: 5
        seed: 0
        val_only_proc: false
        val_ts_size: 0.15
    outs:
    - path: data/interim/data_df.csv
      hash: md5
      md5: dca1fe43cab59355d0d3ad9c2b1dcae5
      size: 11113294
    - path: data/interim/feat_df.csv
      hash: md5
      md5: e51a441e2f178daa4b51c031abb3d49b
      size: 50560718
    - path: data/interim/vec.pkl
      hash: md5
      md5: 124f5d3b3a71398116b84ebbb53d84ff
      size: 119637
  feature_engineering:
    cmd: python src/feat_eng.py params.yaml
    deps:
    - path: data/interim/data_df.csv
      hash: md5
      md5: dca1fe43cab59355d0d3ad9c2b1dcae5
      size: 11113294
    - path: data/interim/feat_df.csv
      hash: md5
      md5: e51a441e2f178daa4b51c031abb3d49b
      size: 50560718
    - path: data/interim/vec.pkl
      hash: md5
      md5: 124f5d3b3a71398116b84ebbb53d84ff
      size: 119637
    - path: src/feat_eng.py
      hash: md5
      md5: 8ff46456063924cf11170b703fe22931
      size: 389
    params:
      params.yaml:
        feat_eng.add_clust_feat: false
        feat_eng.add_ind_cols: true
        feat_eng.add_topic_feat:
        feat_eng.tfidf_dim:
        feat_eng.topic_algo: lsa
        seed: 0
    outs:
    - path: data/out/feat_final_df.csv
      hash: md5
      md5: d93af27ad6f0b852f481d13a064d68df
      size: 50683576
  train_eval_model:
    cmd: python src/train_eval_model.py params.yaml
    deps:
    - path: data/out/feat_final_df.csv
      hash: md5
      md5: d93af27ad6f0b852f481d13a064d68df
      size: 50683576
    - path: src/train_eval_model.py
      hash: md5
      md5: 1c810a84bc50a31b2fb11424c0b7c3f2
      size: 448
    params:
      params.yaml:
        seed: 0
        train_eval_model.attack_clf:
        train_eval_model.balanced:
        train_eval_model.chain: true
        train_eval_model.model: logreg
        train_eval_model.opt_metric: f1
    outs:
    - path: data/out/by_class_metric.csv
      hash: md5
      md5: 7019aacf32d688282e2bb868bf2fced7
      size: 483
    - path: data/out/conf_df.csv
      hash: md5
      md5: 602c00105c35e6eb28bf5baff917ea14
      size: 210951
    - path: data/out/confusion_matrix.png
      hash: md5
      md5: f7023e3fcdece8a790956d156fb9039d
      size: 117547
    - path: data/out/confusion_matrix_main_er.png
      hash: md5
      md5: 0eb539cc4525049bec45abb1d27143d1
      size: 92455
    - path: data/out/m.json
      hash: md5
      md5: fbd759a44adaadc60e261f7bb30815c9
      size: 137
    - path: data/out/m_other.json
      hash: md5
      md5: 7efe8b5ca5ecc4d5ef6cbea73f9dc04b
      size: 555
    - path: data/out/model.pkl
      hash: md5
      md5: 9b7913b55541aadc4ce2a28e94a8975a
      size: 112983
    - path: data/out/opt_metric.csv
      hash: md5
      md5: 7315da49b16eb5a551033b86a6561068
      size: 21081
  train_conv_model:
    cmd: dvc repro dvc_pipes/train_conv_emb/dvc.yaml
  train_bert_model:
    cmd: dvc repro dvc_pipes/bert/dvc.yaml
  train_ttp_classic_model:
    cmd: dvc repro dvc_pipes/ttp/dvc.yaml
  train_ttp_bert_model:
    cmd: dvc repro dvc_pipes/bert_ttp/dvc.yaml
